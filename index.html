<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Leverage - Web3 Casino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: #0f172a; color: #e2e8f0; }
        .neon-text { text-shadow: 0 0 10px #a855f7; }
        .neon-border { box-shadow: 0 0 15px #ec4899; }
        .slot-window { background: #000; border: 4px solid #333; }
        #coinCanvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 50; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center relative">
    <canvas id="coinCanvas"></canvas>

    <nav class="w-full max-w-4xl flex justify-between items-center p-6 absolute top-0">
        <div class="text-xl text-purple-400 neon-text">MINT LEVERAGE</div>
        <div class="flex gap-2">
            <button id="connectBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-[10px] border-2 border-indigo-400">
                连接钱包
            </button>
            <button id="disconnectBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-[10px] border-2 border-red-400">
                退出/切换
            </button>
        </div>
    </nav>

    <div class="bg-gray-800 p-8 rounded-xl border-4 border-purple-500 neon-border max-w-md w-full text-center relative z-10">
        <div class="mb-6">
            <p id="networkLabel" class="text-[8px] text-gray-400 mb-2">NETWORK: DISCONNECTED</p>
            <div id="statusText" class="text-yellow-400 text-[10px] h-6">请先连接钱包</div>
        </div>

        <div class="flex justify-center gap-4 mb-8">
            <div class="slot-window w-16 h-20 flex items-center justify-center text-2xl text-green-400" id="slot1">?</div>
            <div class="slot-window w-16 h-20 flex items-center justify-center text-2xl text-green-400" id="slot2">?</div>
            <div class="slot-window w-16 h-20 flex items-center justify-center text-2xl text-green-400" id="slot3">?</div>
        </div>

        <button id="spinBtn" class="w-full bg-purple-600 py-4 rounded-lg text-sm border-b-4 border-purple-900 active:translate-y-1 transition-all">
            PULL LEVER
        </button>
    </div>

    <script>
        // --- 配置项 ---
        const CONTRACT_ADDRESS = "0xE52f7895b936f3cB5eC3493F077759f75DE101DD"; 
        const ABI = [
	{
		"inputs": [],
		"stateMutability": "payable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "player",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountBet",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "won",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "payout",
				"type": "uint256"
			}
		],
		"name": "GameResult",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "spinWheel",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
        ];

        let provider, signer, contract;

        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusText = document.getElementById('statusText');
        const networkLabel = document.getElementById('networkLabel');

        // 核心功能：连接钱包
        async function connectWallet() {
            if (!window.ethereum) return alert("请安装MetaMask");
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                // 强制弹出选择账号界面（即使已连接过）
                await provider.send("eth_requestAccounts", []); 
                
                signer = await provider.getSigner();
                const addr = await signer.getAddress();
                
                // 检查网络是否为 Sepolia (11155111)
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111n) {
                    alert("请切换到 Sepolia 测试网！");
                    // 这里可以添加自动切换网络的逻辑
                }

                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                // 更新 UI
                updateUI(addr);
                statusText.innerText = "已准备就绪";
            } catch (err) {
                console.error(err);
                statusText.innerText = "连接被取消";
            }
        }

        // 核心功能：退出/清开连接
        function disconnectWallet() {
            // 清空逻辑状态
            provider = null;
            signer = null;
            contract = null;

            // 还原 UI
            connectBtn.classList.remove('hidden');
            disconnectBtn.classList.add('hidden');
            connectBtn.innerText = "连接钱包";
            networkLabel.innerText = "NETWORK: DISCONNECTED";
            statusText.innerText = "已断开连接，请重新登录";
            statusText.className = "text-red-400 text-[10px] h-6";
        }

        function updateUI(address) {
            connectBtn.classList.add('hidden');
            disconnectBtn.classList.remove('hidden');
            networkLabel.innerText = "ADDR: " + address.substring(0, 6) + "..." + address.substring(38);
            statusText.className = "text-green-400 text-[10px] h-6";
        }

        // 监听 MetaMask 的账号变动 (切换钱包)
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    // 账号变动，刷新页面以确保状态同步
                    window.location.reload();
                }
            });
            
            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        connectBtn.addEventListener('click', connectWallet);
        disconnectBtn.addEventListener('click', disconnectWallet);
    </script>
</body>
</html>

