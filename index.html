<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Leverage - Web3 Casino</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .neon-text {
            text-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7, 0 0 20px #a855f7;
        }

        .neon-border {
            box-shadow: 0 0 5px #ec4899, 0 0 10px #ec4899;
        }

        .btn-active:active {
            transform: translateY(4px);
            box-shadow: 0 0 5px #a855f7;
        }

        #coinCanvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 50;
        }

        .slot-window {
            background: #000;
            border: 4px solid #333;
            box-shadow: inset 0 0 20px #000;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center relative">

    <canvas id="coinCanvas"></canvas>

    <nav class="w-full max-w-4xl flex justify-between items-center p-6 absolute top-0">
        <div class="text-2xl text-purple-400 neon-text">MINT LEVERAGE</div>
        <button id="connectBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-xs border-2 border-indigo-400 shadow-lg transition-all">
            Connect Wallet
        </button>
    </nav>

    <div class="bg-gray-800 p-8 rounded-xl border-4 border-purple-500 neon-border max-w-md w-full text-center relative z-10">
        
        <div class="mb-6">
            <p class="text-xs text-gray-400 mb-2">CURRENT NETWORK: SEPOLIA</p>
            <div id="statusText" class="text-yellow-400 text-sm h-6">Let's WIN!!!</div>
        </div>

        <div class="flex justify-center gap-4 mb-8">
            <div class="slot-window w-20 h-24 flex items-center justify-center text-4xl text-green-400" id="slot1">7</div>
            <div class="slot-window w-20 h-24 flex items-center justify-center text-4xl text-green-400" id="slot2">7</div>
            <div class="slot-window w-20 h-24 flex items-center justify-center text-4xl text-green-400" id="slot3">7</div>
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-center gap-2">
                <span class="text-xs">BET AMOUNT:</span>
                <input type="number" id="betAmount" value="0.001" step="0.001" class="bg-gray-900 border border-purple-500 text-white p-2 w-24 text-center text-xs focus:outline-none focus:ring-2 focus:ring-purple-500">
                <span class="text-xs">ETH</span>
            </div>

            <button id="spinBtn" class="w-full bg-gradient-to-b from-purple-600 to-purple-800 text-white py-4 rounded-lg text-lg border-b-4 border-purple-900 btn-active transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                PULL LEVER
            </button>
        </div>
        
        <div class="mt-4 text-[10px] text-gray-500">
            Win Chance: 45% | Payout: 2x
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const CONTRACT_ADDRESS = "0x33C1A3Ec6Ab85480A0f1560F5DeB3adF56Fe4E64"; 
        const ABI = [
            {"inputs": [], "stateMutability": "payable", "type": "constructor"},
            {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "player", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "amountBet", "type": "uint256"}, {"indexed": false, "internalType": "bool", "name": "won", "type": "bool"}, {"indexed": false, "internalType": "uint256", "name": "payout", "type": "uint256"}], "name": "GameResult", "type": "event"},
            {"inputs": [], "name": "spinWheel", "outputs": [], "stateMutability": "payable", "type": "function"},
            {"inputs": [], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
            {"stateMutability": "payable", "type": "receive"},
            {"inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}
        ];

        let provider, signer, contract;
        let particles = [];
        const canvas = document.getElementById('coinCanvas');
        const ctx = canvas.getContext('2d');

        const connectBtn = document.getElementById('connectBtn');
        const spinBtn = document.getElementById('spinBtn');
        const statusText = document.getElementById('statusText');
        const slots = [document.getElementById('slot1'), document.getElementById('slot2'), document.getElementById('slot3')];

        // Resize canvas
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Wallet Connection Logic
        async function connectWallet() {
            if (!window.ethereum) {
                alert("Please install MetaMask!");
                return;
            }
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                
                connectBtn.innerText = address.substring(0,6) + "..." + address.substring(38);
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                statusText.innerText = "Wallet Connected";
                statusText.className = "text-green-400 text-sm h-6";

                // Listen for GameResult events
                contract.on("GameResult", (player, amount, won, payout) => {
                    if (player.toLowerCase() === address.toLowerCase()) {
                        stopSlotAnimation(won);
                        spinBtn.disabled = false;
                        spinBtn.innerText = "PULL LEVER";
                        statusText.innerText = won ? `BIG WIN! +${ethers.formatEther(payout)} ETH` : "BET LOST... TRY AGAIN!";
                    }
                });

            } catch (error) {
                console.error(error);
                statusText.innerText = "Connection Failed";
            }
        }

        connectBtn.addEventListener('click', connectWallet);

        // Slot Animation
        let intervalId;
        function startSlotAnimation() {
            intervalId = setInterval(() => {
                slots.forEach(slot => {
                    slot.innerText = Math.floor(Math.random() * 9);
                    slot.classList.remove('text-yellow-400', 'text-red-500');
                    slot.classList.add('text-green-400');
                });
            }, 80);
        }

        function stopSlotAnimation(won) {
            clearInterval(intervalId);
            if (won) {
                slots.forEach(s => {
                    s.innerText = "7";
                    s.classList.remove('text-green-400');
                    s.classList.add('text-yellow-400');
                });
                startCoinRain(); 
            } else {
                slots.forEach(s => {
                    s.innerText = "X";
                    s.classList.remove('text-green-400');
                    s.classList.add('text-red-500');
                });
            }
        }

        // Particle System (Burst and Rain)
        function createExplosion() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            for (let i = 0; i < 40; i++) {
                particles.push({
                    x: centerX,
                    y: centerY,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20,
                    size: Math.random() * 8 + 4,
                    color: '#facc15',
                    gravity: 0.5
                });
            }
            animate();
        }

        function startCoinRain() {
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: -20,
                    vx: (Math.random() - 0.5) * 2,
                    vy: Math.random() * 5 + 5,
                    size: Math.random() * 10 + 5,
                    color: '#facc15',
                    gravity: 0.1
                });
            }
            animate();
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
                
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity;

                // Remove off-screen particles
                if (p.y > canvas.height) {
                    particles.splice(index, 1);
                }
            });

            if (particles.length > 0) {
                requestAnimationFrame(animate);
            }
        }

        // Game Interaction
        spinBtn.addEventListener('click', async () => {
            if (!contract) {
                alert("Please connect your wallet first!");
                return;
            }

            const betValue = document.getElementById('betAmount').value;
            
            try {
                // Trigger Visual Burst Effect
                createExplosion();

                statusText.innerText = "Confirm in Wallet...";
                statusText.className = "text-yellow-400 text-sm h-6";
                
                const tx = await contract.spinWheel({ 
                    value: ethers.parseEther(betValue) 
                });

                statusText.innerText = "Transaction Mining...";
                spinBtn.disabled = true;
                spinBtn.innerText = "SPINNING...";
                
                startSlotAnimation();
                await tx.wait();
                
            } catch (error) {
                console.error(error);
                clearInterval(intervalId);
                statusText.innerText = "Tx Failed or Cancelled";
                statusText.className = "text-red-500 text-sm h-6";
                spinBtn.disabled = false;
                spinBtn.innerText = "PULL LEVER";
            }
        });
    </script>
</body>
</html>
