<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Leverage - Web3 Casino</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        /* 自定义样式区 */
        body {
            font-family: 'Press Start 2P', cursive; /* 像素风格字体 */
            background-color: #0f172a; /* 深蓝黑背景 */
            color: #e2e8f0;
            overflow-x: hidden;
        }

        /* 霓虹灯文字效果 */
        .neon-text {
            text-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7, 0 0 20px #a855f7;
        }

        /* 霓虹边框 */
        .neon-border {
            box-shadow: 0 0 5px #ec4899, 0 0 10px #ec4899;
        }

        /* 拉杆按钮按下的动画 */
        .btn-active:active {
            transform: translateY(4px);
            box-shadow: 0 0 5px #a855f7;
        }

        /* 像素金币画布 */
        #coinCanvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 50;
        }

        /* 疯狂跳动的数字框 */
        .slot-window {
            background: #000;
            border: 4px solid #333;
            box-shadow: inset 0 0 20px #000;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center relative">

    <canvas id="coinCanvas"></canvas>

    <nav class="w-full max-w-4xl flex justify-between items-center p-6 absolute top-0">
        <div class="text-2xl text-purple-400 neon-text">MINT LEVERAGE</div>
        <button id="connectBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-xs border-2 border-indigo-400 shadow-lg transition-all">
            Connect Wallet
        </button>
    </nav>

    <div class="bg-gray-800 p-8 rounded-xl border-4 border-purple-500 neon-border max-w-md w-full text-center relative z-10">
        
        <div class="mb-6">
            <p class="text-xs text-gray-400 mb-2">CURRENT NETWORK: SEPOLIA</p>
            <div id="statusText" class="text-yellow-400 text-sm h-6">Let's WIN!!!</div>
        </div>

        <div class="flex justify-center gap-4 mb-8">
            <div class="slot-window w-20 h-24 flex items-center justify-center text-4xl text-green-400" id="slot1">7</div>
            <div class="slot-window w-20 h-24 flex items-center justify-center text-4xl text-green-400" id="slot2">7</div>
            <div class="slot-window w-20 h-24 flex items-center justify-center text-4xl text-green-400" id="slot3">7</div>
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-center gap-2">
                <span class="text-xs">BET AMOUNT:</span>
                <input type="number" id="betAmount" value="0.001" step="0.001" class="bg-gray-900 border border-purple-500 text-white p-2 w-24 text-center text-xs focus:outline-none focus:ring-2 focus:ring-purple-500">
                <span class="text-xs">ETH</span>
            </div>

            <button id="spinBtn" class="w-full bg-gradient-to-b from-purple-600 to-purple-800 text-white py-4 rounded-lg text-lg border-b-4 border-purple-900 btn-active transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                PULL LEVER
            </button>
        </div>
        
        <div class="mt-4 text-[10px] text-gray-500">
            Win Chance: 45% | Payout: 2x
        </div>
    </div>

    <script>
        // ================= 配置区 (CONFIG) =================
        // 步骤：部署你的智能合约，将合约地址粘贴到下方引号中
        const CONTRACT_ADDRESS = "0x33C1A3Ec6Ab85480A0f1560F5DeB3adF56Fe4E64"; 
        
        // 简化的 ABI，只包含我们需要的函数
        const ABI = [
           
	{
		"inputs": [],
		"stateMutability": "payable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "player",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountBet",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "won",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "payout",
				"type": "uint256"
			}
		],
		"name": "GameResult",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "spinWheel",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}

        ];
        // =================================================

        let provider, signer, contract;
        let isSpinning = false;

        const connectBtn = document.getElementById('connectBtn');
        const spinBtn = document.getElementById('spinBtn');
        const statusText = document.getElementById('statusText');
        const slots = [document.getElementById('slot1'), document.getElementById('slot2'), document.getElementById('slot3')];

        // 1. 连接钱包逻辑
        async function connectWallet() {
            if (!window.ethereum) {
                alert("请安装 MetaMask!");
                return;
            }
            try {
                // 使用 Ethers v6 的写法
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                
                // 更新 UI
                connectBtn.innerText = address.substring(0,6) + "..." + address.substring(38);
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                statusText.innerText = "钱包已连接";
                statusText.className = "text-green-400 text-sm h-6";
            } catch (error) {
                console.error(error);
                statusText.innerText = "连接失败";
            }
        }

        connectBtn.addEventListener('click', connectWallet);

        // 2. 动画：疯狂跳动的数字
        let intervalId;
        function startSlotAnimation() {
            intervalId = setInterval(() => {
                slots.forEach(slot => {
                    slot.innerText = Math.floor(Math.random() * 9);
                });
            }, 100);
        }

        function stopSlotAnimation(won) {
            clearInterval(intervalId);
            if (won) {
                slots[0].innerText = "7";
                slots[1].innerText = "7";
                slots[2].innerText = "7";
                slots.forEach(s => s.classList.add('text-yellow-400'));
                startCoinRain(); // 播放金币雨
            } else {
                slots[0].innerText = "X";
                slots[1].innerText = "X";
                slots[2].innerText = "X";
                slots.forEach(s => s.classList.remove('text-yellow-400'));
                slots.forEach(s => s.classList.add('text-red-500'));
            }
        }

        // 3. 核心游戏交互
        spinBtn.addEventListener('click', async () => {
            if (!contract) {
                alert("请先连接钱包！");
                return;
            }

            const betValue = document.getElementById('betAmount').value;
            
            try {
                statusText.innerText = "等待确认交易...";
                
                // 发送交易
                const tx = await contract.spinWheel({ 
                    value: ethers.parseEther(betValue) 
                });

                statusText.innerText = "交易打包中 (Mining)...";
                spinBtn.disabled = true;
                spinBtn.innerText = "SPINNING...";
                
                // 开始动画
                startSlotAnimation();

                // 等待交易上链
                const receipt = await tx.wait();

                // 解析日志看输赢
                // 在 Ethers v6 中，我们通常监听事件，但这里为了简单直接在回执里找
                // 注意：这里为了简化，我们假设前端等待事件触发或者解析 Logs
                // 真实环境建议使用 contract.on 监听事件，但为了保持单文件逻辑清晰：
                
                // 我们重新查询一下结果，或者根据 Logs 判断。
                // 这里的 Logs 解析比较复杂，我们简化处理：假设如果不报错就是执行了。
                // 实际在 Log 里有个 args.won 字段。
                
                // 简易处理：通过监听事件来获取确切结果
                // 注意：tx.wait() 返回后，我们实际上应该已经收到了 Event
                
            } catch (error) {
                console.error(error);
                clearInterval(intervalId);
                statusText.innerText = "交易失败或被取消";
                spinBtn.disabled = false;
                spinBtn.innerText = "PULL LEVER";
            }
        });

        // 监听合约事件 (这是获取结果最准确的方法)
        // 注意：要在 connectWallet 后才能绑定
        // 这里的代码需要在 contract 初始化后运行，建议放在 connectWallet 内部或单独处理
        // 为了演示，我们将依赖前端的事件监听
        
        // 补充：为了简化代码，我们在点击按钮时通过 filter 监听当前区块的事件
        // (在实际工程中，这部分代码会更健壮)
        
        // --- 模拟结果展示 (因为没有真实部署合约，这里做个假逻辑供 UI 测试) ---
        // 如果你真的部署了，请注释掉下面这段，解开上面的 tx 逻辑
        /*
        spinBtn.addEventListener('click', () => {
            startSlotAnimation();
            setTimeout(() => {
                const won = Math.random() > 0.5;
                stopSlotAnimation(won);
                statusText.innerText = won ? "YOU WON! ETH SENT!" : "YOU LOST! TRY AGAIN";
            }, 3000);
        });
        */
        
        // 必须要在有了 Contract 实例后监听
        // 实际使用时，请在 connectWallet 成功后执行:
        /*
        contract.on("GameResult", (player, amount, won, payout) => {
             if(player === signer.address) {
                 stopSlotAnimation(won);
                 spinBtn.disabled = false;
                 spinBtn.innerText = "PULL LEVER";
                 statusText.innerText = won ? `WIN! +${ethers.formatEther(payout)} ETH` : "LOST...";
             }
        });
        */


        // 4. 金币雨动画 (Canvas)
        const canvas = document.getElementById('coinCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let coins = [];

        function startCoinRain() {
            coins = [];
            for(let i=0; i<100; i++) {
                coins.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    speed: Math.random() * 5 + 2,
                    size: Math.random() * 10 + 5
                });
            }
            animateCoins();
        }

        function animateCoins() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#facc15'; // Gold
            
            let stillFalling = false;
            coins.forEach(coin => {
                ctx.fillRect(coin.x, coin.y, coin.size, coin.size);
                coin.y += coin.speed;
                if(coin.y < canvas.height) stillFalling = true;
            });

            if(stillFalling) requestAnimationFrame(animateCoins);
            else ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

    </script>
</body>
</html>
